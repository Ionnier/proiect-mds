<!DOCTYPE html>
<html>

<head>
    <title>Home</title>
    <%- include("./fragments/head.ejs") %>
        <style>
            #clicker_button {
                padding: 15px 25px;
                font-size: 24px;
                text-align: center;
                cursor: pointer;
                outline: none;
                color: #fff;
                background-color: #04AA6D;
                border: none;
                border-radius: 15px;
                box-shadow: 0 9px #999;
            }

            #clicker_button:hover {
                background-color: #3e8e41
            }

            #clicker_button:active {
                background-color: #3e8e41;
                box-shadow: 0 5px #666;
                transform: translateY(4px);
            }
        </style>

        <script>
            const map = new Map()
            async function getCurrentCredits() {
                try {
                    const response = await fetch("/api/credits");
                    const data = await response.json();
                    return data.data.credits
                } catch (e) {
                    console.log(e)
                }
            }
            async function updateViewCredits() {
                const currentCredits = await getCurrentCredits()
                if (currentCredits) {
                    document.getElementById('credits_score').innerHTML = `You currently have ${currentCredits} credits.`
                }
            }
            async function increaseCounter() {
                map.set('credits_score', false)
                fetch("/api/credits/increase").then(async (data) => {
                    const json = await data.json()
                    if (json.status == true) {
                        document.getElementById("credits_score").innerHTML = `You currently have ${json.data.credits} credits.`
                    } else {
                        alert(json.message)
                    }
                })
            }
            async function updateService(idService, automatic) {
                const div = document.getElementsByClassName(`service${idService}`)[0]
                if (!div)
                    return
                const service = await fetch(`/api/services/${parseInt(idService)}`)
                const serviceData = await service.json()
                if (!serviceData)
                    return
                if (serviceData.status) {
                    const obj = serviceData.data.data[0]
                    div.getElementsByClassName('serviceName')[0].innerHTML = `Name: ${obj.serviceName}`
                    div.getElementsByClassName('serviceDescription')[0].innerHTML = `Description: ${obj.serviceDescription}`
                    let price
                    let value
                    let level
                    if (obj.boughtservices && obj.boughtservices.length > 0) {
                        level = obj.boughtservices[0].serviceLevel
                        price = obj.serviceBasePrice * Math.pow(obj.servicePriceModifier, level)
                        value = obj.serviceBaseValue * Math.pow(obj.serviceValueModifier, level)
                    } else {
                        price = obj.serviceBasePrice
                        value = obj.serviceBaseValue
                        level = 0
                    }
                    div.getElementsByClassName('servicePrice')[0].innerHTML = `Price: ${price}`
                    div.getElementsByClassName('serviceValue')[0].innerHTML = `Value per Cycle: ${value}`
                    div.getElementsByClassName('level')[0].value = parseInt(level)
                }
                if (automatic) {
                    map.set(`service${idService}`, false)
                }
            }

            async function onChangeInput(args) {
                if (parseInt(args.oldvalue) > parseInt(args.value)) {
                    args.value = args.oldvalue
                } else {
                    let id
                    for (let x of args.classList) {
                        if (x.startsWith('id_service')) {
                            id = parseInt(x.replace('id_service', ''))
                        }
                    }
                    const data = await fetch(`/api/services/increase/${id}`)
                    const json = await data.json()
                    await updateService(id)
                    await updateViewCredits()
                    if (json.success == true) {
                        return true
                    }
                }
            }
            window.addEventListener('load', async () => {
                map.set('credits_score', true)
                for (let x of document.getElementsByClassName('service'))
                    for (let y of x.classList) {
                        if (y.includes('service') && y != 'service' && parseInt(y.replace('service', '')) != undefined) {
                            map.set(y, true)
                            break
                        }
                    }
                setInterval(async () => {
                    for (let [key, value] of map.entries()) {
                        if (value == true) {
                            if (key.includes('service')) {
                                updateService(parseInt(key.replace('service', '')), true)
                            } else {
                                updateViewCredits(true)
                            }
                        } else {
                            map.set(key, true)
                        }
                    }
                }, 60_000)
            }, false);
        </script>
</head>

<body>
    <%- include("./fragments/header.ejs") %>
        <h2>Play</h2>
        <p id="credits_score"> You currently have <%- locals.user.userCredits%> credits.</p>
        <button id="clicker_button" onclick="increaseCounter()">
        </button>

        <% if(locals.services){ %>
            <div id="services_div">
                <% for(let service of locals.services){ %>
                    <div class="service service<%-service.idService %> ">
                        <p class="serviceName">Name:
                            <%- service.serviceName %>
                        </p>
                        <p class="serviceDescription">Description:
                            <%- service.serviceDescription %>
                        </p>
                        <% let price %>
                            <% let value %>
                                <% let level %>
                                    <% if(service.boughtservices.length>0){ %>
                                        <% level=service.boughtservices[0].serviceLevel %>
                                            <% price=service.serviceBasePrice * Math.pow(service.servicePriceModifier,
                                                level) %>
                                                <% value=service.serviceBaseValue *
                                                    Math.pow(service.serviceValueModifier, level) %>
                                                    <% } else{ %>
                                                        <% price=service.serviceBasePrice %>
                                                            <% value=service.serviceBaseValue %>
                                                                <% level=0 %>
                                                                    <%} %>
                                                                        <p class="servicePrice">
                                                                            Price: <%- price %>
                                                                        </p>
                                                                        <p class="serviceValue">
                                                                            Value per Cycle: <%- value %>
                                                                        </p>
                                                                        <p>Level:</p>
                                                                        <input type="number"
                                                                            class="level id_service<%-service.idService %>"
                                                                            min="0" max="<%- service.serviceMaxLevel %>"
                                                                            onfocus="this.oldvalue = this.value;"
                                                                            step="1" value="<%- level %>"
                                                                            onKeyDown="return false"
                                                                            onchange="onChangeInput(this);this.oldvalue = this.value;">
                    </div>
                    <% }%>

            </div>

            <% }%>

</body>

</html>